'use strict';

const napi = require('./util/napi.js');

function rebuild(gyp, argv, callback) {
  const package_json = gyp.package_json;
  
  // Define the commands to run "clean" and "build"
  let commands = [
    { name: 'clean', args: [] },
    { name: 'build', args: ['rebuild'] }
  ];

  // Expand commands based on NAPI settings
  commands = napi.expand_commands(package_json, gyp.opts, commands);

  // Add the commands to the execution queue
  for (let i = commands.length; i !== 0; i--) {
    gyp.todo.unshift(commands[i - 1]);
  }

  // Notify that the callback will be called in the next tick
  process.nextTick(() => {
    // Consider adding error handling or additional post-processing logic here if needed
    log.info('rebuild', 'Commands added to the queue:', commands);
    callback();
  });
}

module.exports = exports = rebuild;

exports.usage = 'Runs "clean" and "build" at once';
