'use strict';

const napi = require('./util/napi.js');

function rebuild(gyp, argv, callback) {
  const packageJson = gyp.package_json;
  let installArgs = [];
  const napiBuildVersion = napi.getBestNapiBuildVersion(packageJson, gyp.opts);

  if (napiBuildVersion !== null) {
    installArgs = [napi.getCommandArg(napiBuildVersion)];
  }

  // Add "clean" and "install" commands to the execution queue
  gyp.todo.unshift(
    { name: 'clean', args: [] },
    { name: 'install', args: installArgs }
  );

  // Notify that the callback will be called in the next tick
  process.nextTick(() => {
    log.info('rebuild', 'Commands added to the queue:', gyp.todo);
    callback();
  });
}

module.exports = exports = rebuild;

exports.usage = 'Runs "clean" and "install" at once';
